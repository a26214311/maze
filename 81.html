<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Frameset//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-frameset.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Start</title>
<script type="text/javascript"  src="javascripts/jquery-1.7.1.min.js"></script>
<script src="javascripts/parse-1.2.19.min.js"></script>
<script type="text/javascript">

var appid = "rekujmyginVtn9rVcPcOR3zxmFpo7MTigNd3t90y";
var jskey = "OjNDfDKeMNoGTR4Pr4iyal6kW0Cgbj5yL4Tebj1v";

var row=4;
var line=4;

var perw=44;
var perh=44;
var gold=new Array();
var goldimg='<img src="img/maoyu.jpg" style="width:'+perw+'px;height:'+perh+'px"></img>';
$(document).ready(function() {
	var r= '<table borderColor=#2459EB border=3>';
	for(var i=0;i<row;i++){
		r=r+'<tr>';
		for(var j=0;j<line;j++){
			var n=i*line+j;
			r=r+'<td id="f_'+i+'_'+j+'" style="background-color:#21C3D5;width:'+perw+'px;height:'+perh+'px"><div id="t_'+i+'_'+j+'" onclick="action(this.id);" style="width:'+perw+'px;height:'+perh+'px">'+''+'</div></td>';
		}
		r=r+'</tr>';
	}
	r=r+'</table>';
	$('#main').html(r);
	init();
}
);


var value=new Array();
var v = new Array();
for(var i=0;i<line;i++){
	value[i] = new Array();
	v[i]=new Array();
}

var st=0;

function init(){
	for(var i=0;i<row;i++){
		for(var j=0;j<line;j++){
			v[i][j]=0;
		}
	}
	var fv=[1,2,3,4,5,6,7,8,11,12,13,14,15,16,17,18];
	var sv = sortRandom(fv);
	console.log(sv);
	for(var i=0;i<row;i++){
		for(var j=0;j<line;j++){
			value[i][j]=sv[i*4+j];
		}
	}
}

function show(){
	for(var i=0;i<row;i++){
		for(var j=0;j<line;j++){
			if(v[i][j]==0){
				$('#t_'+i+'_'+j).html('');
			}else{
				$('#t_'+i+'_'+j).html(value[i][j]);
			}
			if(value[i][j]==-1){
				document.getElementById("f_"+i+"_"+j).style['background-color']="orange";
				$('#t_'+i+'_'+j).html('');
			}else{
				document.getElementById("f_"+i+"_"+j).style['background-color']="#21C3D5";
			}
		}
	}
}

var pre='';
function action(x){
	console.log(st);
	var tx = parseInt(x.split("_")[1]);
	var ty = parseInt(x.split("_")[2]);
	if(st%2==0){
		if(v[tx][ty]==1&&value[tx][ty]==-1){
			alert('error4');
			return;
		}
		document.getElementById("f_"+tx+"_"+ty).style['background-color']="red";
		pre=x;
		st=st+1;
		return;
	}
	if(st%2==1){
		var px = parseInt(pre.split("_")[1]);
		var py = parseInt(pre.split("_")[2]);

		if(Math.abs(tx-px)+Math.abs(ty-py)>1){
			alert('error1');
			st=st-1;
			show();
		}else{
			if(tx==px&&ty==py){
				console.log(tx,ty,px,py,v[px][py])
				if(v[px][py]==0){
					v[px][py]=1;
					st=(st+1)%4;
					show();
				}else{
					st=st-1;
					console.log('did nothing');
					show();
				}
			}else{
				if(v[tx][ty]==1&&v[px][py]==1){
					var tc=value[tx][ty]>9?1:0;
					var pc=value[px][py]>9?1:0;
					var tv = value[tx][ty]%10;
					var pv = value[px][py]%10;
					console.log(tc,pc,tv,pv);
					if(pc==Math.floor(st/2)){
						if(value[tx][ty]==-1&&value[px][py]>-1){
							value[tx][ty]=value[px][py];
							value[px][py]=-1;
							st=(st+1)%4;
							show();
							return;
						}
						if(tc!=pc){
							if(pv==tv){
								value[tx][ty]=-1;
								value[px][py]=-1;
								st=(st+1)%4;
								show();
							}
							if(ifwin(pv,tv)){
								value[tx][ty]=value[px][py];
								value[px][py]=-1;
								st=(st+1)%4;
								show();
							}else{
								st=st-1;
								console.log('did nothing');
								show();
							}
						}else{
							st=st-1;
							console.log('did nothing');
							show();
						}
					}else{
						alert('error3');
						st=st-1;
						show();
					}
				}else{
					alert('error2');
					st=st-1;
					show();
				}
			}
		}
		return;
	}
}

function ifwin(a,b){
	if(a==1&&b==8){
		return true;
	}
	if(a==8&&b==1){
		return false;
	}
	return a>b;
}





  function sortRandom(arr) {
    var sort = new Array(arr.length);
    for (var i = 0; i < arr.length; i++) {
      var rdm = Math.floor(Math.random() * arr.length);
      clash(arr[i], sort, (rdm) % arr.length);
    }
    return sort;
  }

  function clash(obj, newarr, index) {
    if (!newarr[index]) {
      newarr[index] = obj;
    } else {
      clash(obj, newarr, (index + 1) % newarr.length)
    }
  }

</script>
</head>
<body>
<table>
<tr>
<td>
<div id="main" style="text-align:center"></div>
</td>
<td>
<div id="info">
</div>
</td>
</tr>
</table>
<div id="text"></div>

</body>
</html>
